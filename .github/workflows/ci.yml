name: CI

# Comprehensive CI pipeline that runs on every push and PR
# Backend-only checks (frontend is in separate repo: gun-del-sol-web)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  backend-lint:
    name: Backend Linting
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: backend/requirements-dev.txt

      - name: Install dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Check formatting
        working-directory: backend
        run: |
          black --check --diff .
          isort --check-only --diff .

      - name: Lint with flake8
        working-directory: backend
        run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

  backend-test:
    name: Backend Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: backend/requirements-dev.txt

      - name: Install dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Create test config
        working-directory: backend
        run: |
          echo '{"helius_api_key": "test-key"}' > config.json
          echo '{"walletCount": 5, "concurrentAnalysis": 3}' > api_settings.json
          echo '[]' > monitored_addresses.json

      - name: Run pytest
        working-directory: backend
        run: pytest --cov=app --cov-report=xml --cov-report=term -v

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            backend/coverage.xml
            backend/.coverage
          retention-days: 30

  all-checks-complete:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [backend-lint, backend-test]
    if: always()

    steps:
      - name: Check job results
        id: check
        run: |
          echo "lint_result=${{ needs.backend-lint.result }}" >> $GITHUB_OUTPUT
          echo "test_result=${{ needs.backend-test.result }}" >> $GITHUB_OUTPUT

          if [[ "${{ needs.backend-lint.result }}" == "failure" ]] || \
             [[ "${{ needs.backend-test.result }}" == "failure" ]]; then
            echo "One or more checks failed"
            exit 1
          fi
          echo "All backend checks passed successfully!"

      - name: Create job summary
        if: always()
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Lint results
          if [[ "${{ needs.backend-lint.result }}" == "success" ]]; then
            echo "âœ… **Backend Linting:** Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Backend Linting:** Failed" >> $GITHUB_STEP_SUMMARY
          fi

          # Test results
          if [[ "${{ needs.backend-test.result }}" == "success" ]]; then
            echo "âœ… **Backend Tests:** Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Backend Tests:** Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          if [[ "${{ needs.backend-lint.result }}" == "success" ]] && \
             [[ "${{ needs.backend-test.result }}" == "success" ]]; then
            echo "ğŸ‰ **Overall Status:** All checks passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Overall Status:** Some checks failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review the failed jobs above and fix the issues before merging." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment on PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const lintResult = '${{ needs.backend-lint.result }}';
            const testResult = '${{ needs.backend-test.result }}';

            const lintEmoji = lintResult === 'success' ? 'âœ…' : 'âŒ';
            const testEmoji = testResult === 'success' ? 'âœ…' : 'âŒ';

            const allPassed = lintResult === 'success' && testResult === 'success';
            const status = allPassed ? 'âœ… All checks passed!' : 'âš ï¸ Some checks failed';

            const comment = `### CI Pipeline Results ${allPassed ? 'ğŸ‰' : 'âš ï¸'}

            ${lintEmoji} **Backend Linting:** ${lintResult}
            ${testEmoji} **Backend Tests:** ${testResult}

            ---

            ${status}

            **Commit:** ${context.sha.substring(0, 7)}
            **Branch:** ${context.ref.replace('refs/heads/', '')}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });