# Codecov Setup & Verification Guide

**Generated:** 2025-11-12
**Purpose:** Ensure Codecov integration is properly configured for coverage reporting

---

## Current Status

### Backend Repository (solscan_hotkey)
- ✅ **Coverage generation:** Configured in [backend-ci.yml:84](../workflows/backend-ci.yml)
- ✅ **Codecov upload:** Using `codecov/codecov-action@v4`
- ✅ **Badge in README:** Present (line 6 of [README.md](../../README.md))
- ⚠️ **CODECOV_TOKEN:** Needs verification (see below)
- ✅ **Fail-safe mode:** `fail_ci_if_error: false` (won't break CI if upload fails)

### Frontend Repository (gun-del-sol-web)
- ❌ **Coverage not configured:** No test coverage setup yet
- ℹ️ **Future roadmap:** Consider adding Jest/Vitest + coverage later

---

## What is Codecov?

[Codecov](https://codecov.io) is a code coverage reporting service that:
- Visualizes test coverage across your codebase
- Tracks coverage trends over time
- Comments on PRs with coverage changes
- Provides coverage badges for README files
- Helps identify untested code paths

**Free for public repositories**, requires paid plan for private repos (or use Codecov self-hosted).

---

## Current Implementation

### Backend Coverage Workflow

From [backend-ci.yml:86-93](../workflows/backend-ci.yml):

```yaml
- name: Upload coverage reports
  uses: codecov/codecov-action@v4
  with:
    file: backend/coverage.xml
    flags: backend
    fail_ci_if_error: false
  env:
    CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
```

**Key Details:**
- Uploads `backend/coverage.xml` generated by pytest
- Uses flag `backend` to distinguish from potential frontend coverage
- Token required for private repos or enhanced features
- Won't fail CI if upload fails (graceful degradation)

### Coverage Badge

Current badge in [README.md](../../README.md):
```markdown
[![codecov](https://codecov.io/gh/88simon/solscan_hotkey/branch/main/graph/badge.svg)](https://codecov.io/gh/88simon/solscan_hotkey)
```

Points to: `https://codecov.io/gh/88simon/solscan_hotkey`

---

## Verification Checklist

### 1. Check if CODECOV_TOKEN Secret Exists

**Via GitHub Web UI:**
1. Go to: https://github.com/88simon/solscan_hotkey/settings/secrets/actions
2. Look for `CODECOV_TOKEN` in the "Repository secrets" list
3. You won't see the value, but it should show "Updated X days ago"

**Via GitHub CLI:**
```bash
gh secret list --repo 88simon/solscan_hotkey
```

Expected output should include:
```
CODECOV_TOKEN  Updated 2024-XX-XX
```

### 2. Check Codecov Dashboard Access

1. Visit: https://codecov.io/gh/88simon/gun_del_sol (or https://app.codecov.io/github/88simon/gun_del_sol)
2. If you see coverage reports → Token is working ✅
3. If you see 404 or "Repository not found" → Token may be missing or invalid ⚠️

### 3. Check Recent Workflow Runs

1. Go to: https://github.com/88simon/gun_del_sol/actions/workflows/backend-ci.yml
2. Click on a recent successful run
3. Expand the "Run Tests" job
4. Look for the "Upload coverage reports" step
5. Check for messages like:
   - ✅ `Success: Coverage uploaded to Codecov`
   - ⚠️ `Warning: Token not found, using tokenless upload`
   - ❌ `Error: Failed to upload coverage`

### 4. Verify Badge is Working

Test badge URL:
```bash
curl -I https://codecov.io/gh/88simon/gun_del_sol/branch/main/graph/badge.svg
```

Expected response:
- ✅ `HTTP/2 200` → Badge working
- ⚠️ `HTTP/2 404` → Repository not found on Codecov
- ⚠️ `HTTP/2 403` → Authentication issue

---

## Setup Instructions

### If CODECOV_TOKEN is Missing

#### Option 1: Get Token from Codecov (Recommended)

1. **Sign in to Codecov:**
   - Go to: https://codecov.io
   - Click "Log in with GitHub"
   - Authorize Codecov to access your repos

2. **Find Your Repository:**
   - Navigate to: https://codecov.io/gh/88simon/gun_del_sol
   - If not listed, click "Add new repository" and select `gun_del_sol`

3. **Get Upload Token:**
   - Click "Settings" tab
   - Navigate to "General" section
   - Copy the "Upload Token" (looks like: `abcd1234-5678-90ef-ghij-klmnopqrstuv`)

4. **Add Token to GitHub Secrets:**
   ```bash
   # Via GitHub CLI
   gh secret set CODECOV_TOKEN --repo 88simon/gun_del_sol
   # Paste token when prompted
   ```

   Or via Web UI:
   - Go to: https://github.com/88simon/gun_del_sol/settings/secrets/actions
   - Click "New repository secret"
   - Name: `CODECOV_TOKEN`
   - Value: Paste the token from Codecov
   - Click "Add secret"

5. **Test the Integration:**
   ```bash
   # Trigger a test workflow run
   gh workflow run backend-ci.yml --repo 88simon/gun_del_sol

   # Or push a commit to trigger CI
   git commit --allow-empty -m "test: verify codecov integration"
   git push
   ```

#### Option 2: Tokenless Upload (Public Repos Only)

For public repositories, Codecov supports tokenless uploads:

**Modify backend-ci.yml:**
```yaml
- name: Upload coverage reports
  uses: codecov/codecov-action@v4
  with:
    file: backend/coverage.xml
    flags: backend
    fail_ci_if_error: false
  # Remove env section entirely for tokenless upload
```

**Note:** Tokenless uploads have limitations:
- Less reliable (may fail during outages)
- No PR comments
- Limited API access
- **Not recommended for production use**

---

## Adding codecov.yml Configuration (Optional)

Create [codecov.yml](../../codecov.yml) in repository root for advanced settings:

```yaml
# Codecov configuration for Gun Del Sol backend
# https://docs.codecov.com/docs/codecov-yaml

coverage:
  status:
    project:
      default:
        target: 80%          # Target coverage percentage
        threshold: 2%        # Allow 2% drop without failing

    patch:
      default:
        target: 70%          # New code should have 70% coverage

comment:
  layout: "header, diff, flags, components"
  behavior: default          # Comment on PRs with coverage changes
  require_changes: true      # Only comment if coverage changed

ignore:
  - "backend/tests/"         # Don't count test files
  - "backend/app/utils/logger.py"  # Exclude logger utilities
  - "**/__init__.py"         # Ignore init files

flags:
  backend:
    paths:
      - backend/app/
    carryforward: true       # Keep coverage from previous builds if tests don't run

# Component-based coverage (optional)
component_management:
  individual_components:
    - component_id: routers
      paths:
        - backend/app/routers/
    - component_id: services
      paths:
        - backend/app/services/
    - component_id: models
      paths:
        - backend/app/utils/models.py
```

**Commit and push this file to activate settings.**

---

## Troubleshooting

### Coverage Not Uploading

**Symptom:** Workflow completes but no coverage on Codecov.

**Solutions:**
1. Check `CODECOV_TOKEN` secret exists and is valid
2. Verify `backend/coverage.xml` is generated before upload step
3. Check workflow logs for upload errors
4. Ensure repository is added to Codecov dashboard
5. Try re-generating token in Codecov settings

### Badge Shows "Unknown"

**Symptom:** Coverage badge displays "unknown" instead of percentage.

**Solutions:**
1. Wait 5-10 minutes after first upload (Codecov processes data)
2. Verify at least one successful upload completed
3. Check badge URL matches repository name exactly
4. Try force-refreshing badge: Add `?token=YOUR_REPO_TOKEN` to URL

### PR Comments Not Appearing

**Symptom:** Codecov doesn't comment on pull requests.

**Solutions:**
1. Ensure `CODECOV_TOKEN` is set (required for PR comments)
2. Check Codecov app has PR comment permissions in GitHub
3. Verify `codecov.yml` has `comment.behavior: default`
4. Re-authorize Codecov app if recently changed repo settings

### "Tokenless upload rejected"

**Symptom:** Error: `Tokenless uploads are not allowed for this repository`.

**Solutions:**
1. Repository is likely private → token required
2. Add `CODECOV_TOKEN` secret following "Setup Instructions" above
3. Or make repository public if appropriate

---

## Best Practices

### Coverage Targets

Set realistic coverage goals:
- **80%+** → Excellent (recommended target)
- **70-80%** → Good (acceptable for complex projects)
- **60-70%** → Fair (needs improvement)
- **<60%** → Poor (high risk of bugs)

### What to Cover

**High Priority (must have tests):**
- Routers and API endpoints
- Business logic in services
- Data validation and transformations
- Authentication/authorization
- Error handling paths

**Low Priority (optional):**
- Simple getters/setters
- Configuration loading
- Logger/utility wrappers
- Init files

### Monitoring Coverage Trends

1. **Weekly check:** Review Codecov dashboard for trends
2. **PR reviews:** Check coverage impact before merging
3. **Quarterly goal:** Gradually increase coverage target
4. **Alert on drops:** Investigate if coverage drops >5%

---

## Integration with Branch Protection

### Add Coverage Check as Required Status (Optional)

If you want to block merges when coverage drops significantly:

1. **Enable Codecov GitHub App Checks:**
   - Go to: https://github.com/apps/codecov
   - Click "Configure"
   - Select `solscan_hotkey` repository
   - Enable "Commit Status" checks

2. **Add to Branch Protection:**
   - Go to: Settings → Branches → Edit rule for `main`
   - Add required status check: `codecov/project`
   - Add required status check: `codecov/patch`

3. **Configure Thresholds in codecov.yml:**
   ```yaml
   coverage:
     status:
       project:
         default:
           target: 80%
           threshold: 2%
           if_ci_failed: error  # Fail if coverage drops
   ```

**Warning:** Only enable this if team commits to maintaining coverage, otherwise it can block legitimate PRs.

---

## Next Steps

1. ✅ **Verify Token:** Check if `CODECOV_TOKEN` secret exists
2. ⏭️ **Add if Missing:** Follow "Setup Instructions" above
3. ⏭️ **Test Upload:** Trigger workflow and verify upload succeeds
4. ⏭️ **Check Dashboard:** Confirm coverage appears on Codecov
5. ⏭️ **Validate Badge:** Ensure README badge displays correctly
6. ⏭️ **(Optional) Add codecov.yml:** Configure advanced settings
7. ⏭️ **(Optional) Enable PR Comments:** Verify Codecov app permissions

---

## Resources

- **Codecov Docs:** https://docs.codecov.com
- **GitHub Action:** https://github.com/codecov/codecov-action
- **Configuration Reference:** https://docs.codecov.com/docs/codecov-yaml
- **Pytest Coverage:** https://pytest-cov.readthedocs.io/en/latest/
- **Badge Formats:** https://docs.codecov.com/docs/status-badges

---

## Related Files

- [backend-ci.yml](../workflows/backend-ci.yml) - Coverage upload workflow
- [README.md](../../README.md) - Coverage badge location
- [backend/pytest.ini](../../backend/pytest.ini) - Pytest coverage configuration (if exists)

---

**Maintained by:** Gun Del Sol Team
**Last Updated:** 2025-11-12