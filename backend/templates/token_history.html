<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Analysis History - Solana Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #2d3748;
            margin-bottom: 5px;
        }

        .header p {
            color: #718096;
        }

        .nav-links {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 14px;
            transition: background 0.2s;
        }

        .nav-btn:hover {
            background: #5568d3;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            color: #718096;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .stat-card .value {
            color: #2d3748;
            font-size: 32px;
            font-weight: bold;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .card h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f7fafc;
        }

        th {
            text-align: left;
            padding: 12px;
            color: #4a5568;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            color: #2d3748;
        }

        tr:hover {
            background: #f7fafc;
        }

        .token-name {
            font-weight: 600;
            color: #2d3748;
        }

        .token-symbol {
            color: #718096;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .acronym-badge {
            display: inline-block;
            padding: 4px 10px;
            background: #e6fffa;
            color: #234e52;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .address-cell {
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .timestamp {
            color: #718096;
            font-size: 12px;
        }

        .wallets-badge {
            display: inline-block;
            padding: 4px 12px;
            background: #667eea;
            color: white;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .action-btn {
            padding: 6px 12px;
            font-size: 12px;
            margin-right: 5px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #4a5568;
        }

        .message {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .message.success {
            background: #c6f6d5;
            color: #22543d;
            border-left: 4px solid #48bb78;
        }

        .message.error {
            background: #fed7d7;
            color: #742a2a;
            border-left: 4px solid #f56565;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .spinner {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .wallet-list {
            margin-top: 10px;
        }

        .wallet-item {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            color: #4a5568;
            padding: 4px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .wallet-item:last-child {
            border-bottom: none;
        }

        .wallet-label {
            color: #667eea;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üìä Token Analysis History</h1>
                <p>View and manage analyzed tokens with early buyer data</p>
            </div>
            <div class="nav-links">
                <a href="/" class="nav-btn">üè† Dashboard</a>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <h3>Total Analyzed Tokens</h3>
                <div class="value" id="total-tokens">0</div>
            </div>
            <div class="stat-card">
                <h3>Tracked Wallets</h3>
                <div class="value" id="total-wallets">0</div>
            </div>
            <div class="stat-card">
                <h3>Latest Analysis</h3>
                <div class="value" style="font-size: 16px;" id="latest-analysis">-</div>
            </div>
        </div>

        <div class="card">
            <h2>üîç Analyzed Tokens</h2>

            <div class="search-box">
                <input type="text" id="search" placeholder="üîç Search by token name, symbol, or address...">
            </div>

            <div id="message" class="message"></div>

            <div id="tokens-container">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading token history...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // OPSEC: Disable console logging in production
        // ============================================================================
        // Debug mode is controlled by debug_config.py on the server
        let DEBUG = false;  // Will be loaded from server

        // Fetch debug config from server
        fetch('/api/debug/config')
            .then(res => res.json())
            .then(config => {
                DEBUG = config.debug === "true";
                console.log('[Init] Debug mode:', DEBUG);
            })
            .catch(() => {
                DEBUG = false; // Default to safe mode if fetch fails
            });

        const originalLog = console.log;
        console.log = function(...args) {
            if (DEBUG) originalLog.apply(console, args);
        };
        // ============================================================================

        let tokens = [];

        // Load tokens on page load
        async function loadTokens() {
            try {
                console.log('[TokenHistory] Fetching tokens from API...');
                const response = await fetch('/api/tokens/history');
                console.log('[TokenHistory] Response status:', response.status);

                const data = await response.json();
                console.log('[TokenHistory] Data received:', data);

                tokens = data.tokens || [];
                console.log('[TokenHistory] Number of tokens:', tokens.length);

                // Update stats
                document.getElementById('total-tokens').textContent = data.total || 0;
                document.getElementById('total-wallets').textContent = data.total_wallets || 0;

                if (tokens.length > 0) {
                    // Convert UTC to local time
                    const latestTimestamp = tokens[0].analysis_timestamp.replace(' ', 'T') + 'Z';
                    const latestDate = new Date(latestTimestamp);
                    document.getElementById('latest-analysis').textContent =
                        latestDate.toLocaleDateString() + ' ' + latestDate.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
                } else {
                    document.getElementById('latest-analysis').textContent = '-';
                }

                console.log('[TokenHistory] Calling renderTable...');
                renderTable();
                console.log('[TokenHistory] renderTable completed');
            } catch (error) {
                console.error('[TokenHistory] Error:', error);
                showMessage('Error loading tokens: ' + error.message, 'error');
                document.getElementById('tokens-container').innerHTML =
                    '<div class="empty-state"><h3>Error loading data</h3><p>' + error.message + '</p></div>';
            }
        }

        // Render table
        function renderTable(filter = '') {
            const container = document.getElementById('tokens-container');

            let filtered = tokens;
            if (filter) {
                filter = filter.toLowerCase();
                filtered = tokens.filter(token =>
                    (token.token_name && token.token_name.toLowerCase().includes(filter)) ||
                    (token.token_symbol && token.token_symbol.toLowerCase().includes(filter)) ||
                    (token.acronym && token.acronym.toLowerCase().includes(filter)) ||
                    (token.token_address && token.token_address.toLowerCase().includes(filter))
                );
            }

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No tokens found</h3><p>Use the AutoHotkey Analyze wedge to analyze tokens</p></div>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Token</th>
                            <th>Address</th>
                            <th>Actions</th>
                            <th>Acronym</th>
                            <th>Wallets</th>
                            <th>Credits Used For Latest Report</th>
                            <th>Cumulative Credits Used</th>
                            <th>First Buy</th>
                            <th>Analyzed</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            filtered.forEach(token => {
                // Convert UTC timestamps to local time
                // SQLite CURRENT_TIMESTAMP returns UTC without 'Z', so we append it
                const analysisTimestamp = token.analysis_timestamp.replace(' ', 'T') + 'Z';
                const analysisDate = new Date(analysisTimestamp);

                let firstBuyDate = null;
                if (token.first_buy_timestamp) {
                    const firstBuyTimestamp = token.first_buy_timestamp.replace(' ', 'T') + 'Z';
                    firstBuyDate = new Date(firstBuyTimestamp);
                }

                html += `
                    <tr>
                        <td>
                            <div class="token-name">${token.token_name || 'Unknown'}</div>
                            <div class="token-symbol">${token.token_symbol || '-'}</div>
                        </td>
                        <td class="address-cell">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <a href="https://solscan.io/token/${token.token_address}" target="_blank"
                                   style="color: #667eea; text-decoration: none;">
                                    ${token.token_address.substring(0, 8)}...${token.token_address.substring(token.token_address.length - 6)}
                                </a>
                                <button onclick="copyAddress('${token.token_address}')"
                                        style="padding: 4px 8px; font-size: 12px; background: #48bb78; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap;"
                                        title="Copy address">
                                    üìã Copy
                                </button>
                            </div>
                        </td>
                        <td style="white-space: nowrap;">
                            <button class="action-btn btn-primary" onclick="viewDetails(${token.id})">
                                üìã Details
                            </button>
                            <button class="action-btn btn-success" onclick="downloadAxiom(${token.id})">
                                üì• Axiom JSON
                            </button>
                            <button class="action-btn btn-danger" onclick="deleteToken(${token.id}, '${token.token_name || 'Unknown'}')">
                                üóëÔ∏è Delete
                            </button>
                        </td>
                        <td>
                            <span class="acronym-badge">${token.acronym}</span>
                        </td>
                        <td>
                            <span class="wallets-badge">${token.wallets_found} wallets</span>
                        </td>
                        <td style="font-weight: 600; color: #48bb78;">
                            ${token.last_analysis_credits || 0}
                        </td>
                        <td style="font-weight: 600; color: #f59e0b;">
                            ${token.credits_used || 0}
                        </td>
                        <td class="timestamp">
                            ${firstBuyDate ? firstBuyDate.toLocaleString() : '-'}
                        </td>
                        <td class="timestamp">
                            ${analysisDate.toLocaleString()}
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // View token details
        async function viewDetails(tokenId) {
            try {
                // Fetch both current details and history
                const [detailsResponse, historyResponse] = await Promise.all([
                    fetch(`/api/tokens/${tokenId}`),
                    fetch(`/api/tokens/${tokenId}/history`)
                ]);

                const data = await detailsResponse.json();
                const historyData = await historyResponse.json();

                if (!data || data.error) {
                    showMessage(data.error || 'Failed to load token details', 'error');
                    return;
                }

                // Build current analysis table HTML
                let tableHtml = '<table><thead><tr>' +
                    '<th>Rank</th>' +
                    '<th>Wallet Address</th>' +
                    '<th>Actions</th>' +
                    '<th>First Buy Time</th>' +
                    '<th>Amount (USD)</th>' +
                    '<th>Txns</th>' +
                    '<th>Avg Buy</th>' +
                    '</tr></thead><tbody>';

                if (data.wallets && data.wallets.length > 0) {
                    data.wallets.forEach((wallet, index) => {
                        // Convert UTC timestamp to local time
                        const firstBuyTimestamp = wallet.first_buy_timestamp.replace(' ', 'T') + 'Z';
                        const firstBuyDate = new Date(firstBuyTimestamp);
                        const totalUsd = wallet.total_usd ? `$${Math.round(wallet.total_usd)}` : 'N/A';
                        const avgUsd = wallet.average_buy_usd ? `$${Math.round(wallet.average_buy_usd)}` : 'N/A';

                        tableHtml += `
                            <tr>
                                <td style="font-weight: 600; color: #667eea;">${index + 1}</td>
                                <td class="address-cell">${wallet.wallet_address}</td>
                                <td>
                                    <button onclick="copyAddress('${wallet.wallet_address}')" style="padding: 4px 8px; font-size: 11px; background: #48bb78; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        üìã Copy
                                    </button>
                                    <a href="https://solscan.io/account/${wallet.wallet_address}" target="_blank" style="padding: 4px 8px; font-size: 11px; background: #667eea; color: white; text-decoration: none; border-radius: 4px; display: inline-block; margin-left: 4px;">
                                        üîç View
                                    </a>
                                </td>
                                <td>${firstBuyDate.toLocaleString()}</td>
                                <td>${totalUsd}</td>
                                <td>${wallet.transaction_count || 1}</td>
                                <td>${avgUsd}</td>
                            </tr>
                        `;
                    });
                } else {
                    tableHtml += '<tr><td colspan="7" style="text-align: center; padding: 30px; color: #718096;">No wallets found</td></tr>';
                }
                tableHtml += '</tbody></table>';

                // Build history HTML
                let historyHtml = '';
                if (historyData && historyData.runs && historyData.runs.length > 0) {
                    historyData.runs.forEach((run, runIndex) => {
                        const runTimestamp = new Date(run.analysis_timestamp.replace(' ', 'T') + 'Z').toLocaleString();
                        const isLatest = runIndex === 0;

                        let runTableHtml = '<table><thead><tr>' +
                            '<th>Rank</th><th>Wallet Address</th><th>Actions</th>' +
                            '<th>First Buy Time</th><th>Amount (USD)</th><th>Txns</th><th>Avg Buy</th>' +
                            '</tr></thead><tbody>';

                        if (run.wallets && run.wallets.length > 0) {
                            run.wallets.forEach((wallet, index) => {
                                const firstBuyTimestamp = wallet.first_buy_timestamp.replace(' ', 'T') + 'Z';
                                const firstBuyDate = new Date(firstBuyTimestamp);
                                const totalUsd = wallet.total_usd ? `$${Math.round(wallet.total_usd)}` : 'N/A';
                                const avgUsd = wallet.average_buy_usd ? `$${Math.round(wallet.average_buy_usd)}` : 'N/A';

                                runTableHtml += `
                                    <tr>
                                        <td style="font-weight: 600; color: #667eea;">${index + 1}</td>
                                        <td class="address-cell">${wallet.wallet_address}</td>
                                        <td>
                                            <button onclick="copyAddress('${wallet.wallet_address}')" style="padding: 4px 8px; font-size: 11px; background: #48bb78; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                                üìã Copy
                                            </button>
                                            <a href="https://solscan.io/account/${wallet.wallet_address}" target="_blank" style="padding: 4px 8px; font-size: 11px; background: #667eea; color: white; text-decoration: none; border-radius: 4px; display: inline-block; margin-left: 4px;">
                                                üîç View
                                            </a>
                                        </td>
                                        <td>${firstBuyDate.toLocaleString()}</td>
                                        <td>${totalUsd}</td>
                                        <td>${wallet.transaction_count || 1}</td>
                                        <td>${avgUsd}</td>
                                    </tr>
                                `;
                            });
                        } else {
                            runTableHtml += '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #718096;">No wallets in this run</td></tr>';
                        }
                        runTableHtml += '</tbody></table>';

                        historyHtml += `
                            <div style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                                    <div>
                                        <h4 style="margin: 0; color: #2d3748;">Analysis #${historyData.runs.length - runIndex}${isLatest ? ' <span style="background: #e6fffa; color: #234e52; padding: 2px 8px; border-radius: 10px; font-size: 11px;">Latest</span>' : ''}</h4>
                                        <div style="color: #718096; font-size: 12px; margin-top: 4px;">${runTimestamp}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-weight: 600; color: #2d3748;">${run.wallets_found} wallets</div>
                                        <div style="color: #718096; font-size: 12px;">${run.credits_used} credits</div>
                                    </div>
                                </div>
                                ${runTableHtml}
                            </div>
                        `;
                    });
                } else {
                    historyHtml = '<div style="text-align: center; padding: 40px; color: #718096;">No analysis history available</div>';
                }

                const detailsHtml = `
                    <div style="padding: 20px;">
                        <div style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h2 style="color: #2d3748; margin-bottom: 20px;">${data.token_name} (${data.token_symbol})</h2>

                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 25px; padding: 15px; background: #f7fafc; border-radius: 6px;">
                                <div>
                                    <strong style="color: #4a5568;">Token Address:</strong>
                                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #2d3748; margin-top: 5px;">
                                        ${data.token_address}
                                        <button onclick="copyAddress('${data.token_address}')" style="margin-left: 8px; padding: 2px 8px; font-size: 10px; background: #48bb78; color: white; border: none; border-radius: 3px; cursor: pointer;">
                                            Copy
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <strong style="color: #4a5568;">Acronym:</strong>
                                    <div style="margin-top: 5px;">
                                        <span style="display: inline-block; padding: 4px 12px; background: #e6fffa; color: #234e52; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                            ${data.acronym}
                                        </span>
                                    </div>
                                </div>
                                <div>
                                    <strong style="color: #4a5568;">Wallets Found:</strong>
                                    <div style="color: #2d3748; font-size: 20px; font-weight: 600; margin-top: 5px;">${data.wallets_found}</div>
                                </div>
                                <div>
                                    <strong style="color: #4a5568;">Analyzed:</strong>
                                    <div style="color: #718096; font-size: 12px; margin-top: 5px;">${new Date(data.analysis_timestamp.replace(' ', 'T') + 'Z').toLocaleString()}</div>
                                </div>
                            </div>

                            <!-- Tabs -->
                            <div class="tabs-container">
                                <div class="tabs" style="border-bottom: 2px solid #e2e8f0; margin-bottom: 20px;">
                                    <button class="tab-btn active" onclick="switchTab(event, 'current')" style="padding: 10px 20px; border: none; background: none; cursor: pointer; border-bottom: 2px solid #667eea; font-weight: 600; color: #667eea; margin-right: 10px;">
                                        Latest Analysis
                                    </button>
                                    <button class="tab-btn" onclick="switchTab(event, 'history')" style="padding: 10px 20px; border: none; background: none; cursor: pointer; border-bottom: 2px solid transparent; color: #718096; margin-right: 10px;">
                                        üìä History (${historyData?.total_runs || 0} runs)
                                    </button>
                                </div>

                                <div id="tab-current" class="tab-content" style="display: block;">
                                    <h3 style="color: #2d3748; margin-bottom: 15px;">Early Buyer Wallets</h3>
                                    ${tableHtml}
                                </div>

                                <div id="tab-history" class="tab-content" style="display: none;">
                                    <h3 style="color: #2d3748; margin-bottom: 15px;">Analysis History</h3>
                                    ${historyHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Open popup window with better styling
                const detailsWindow = window.open('', 'Token Details', 'width=1200,height=800');
                detailsWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>${data.token_name} - Early Buyers</title>
                        <style>
                            * { margin: 0; padding: 0; box-sizing: border-box; }
                            body {
                                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                min-height: 100vh;
                            }
                            table {
                                width: 100%;
                                border-collapse: collapse;
                                margin-top: 15px;
                                background: white;
                            }
                            thead {
                                background: #f7fafc;
                            }
                            th {
                                text-align: left;
                                padding: 12px;
                                color: #4a5568;
                                font-weight: 600;
                                font-size: 12px;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                                border-bottom: 2px solid #e2e8f0;
                            }
                            td {
                                padding: 12px;
                                border-bottom: 1px solid #e2e8f0;
                                color: #2d3748;
                                font-size: 13px;
                            }
                            tr:hover {
                                background: #f7fafc;
                            }
                            .address-cell {
                                font-family: 'Courier New', monospace;
                                font-size: 11px;
                                color: #2d3748;
                            }
                        </style>
                        <script>
                            function copyAddress(address) {
                                navigator.clipboard.writeText(address).then(() => {
                                    alert('Address copied to clipboard!');
                                }).catch(err => {
                                    console.error('Failed to copy:', err);
                                });
                            }

                            function switchTab(event, tabName) {
                                // Hide all tab content
                                const tabContents = document.getElementsByClassName('tab-content');
                                for (let i = 0; i < tabContents.length; i++) {
                                    tabContents[i].style.display = 'none';
                                }

                                // Remove active class from all buttons
                                const tabBtns = document.getElementsByClassName('tab-btn');
                                for (let i = 0; i < tabBtns.length; i++) {
                                    tabBtns[i].style.borderBottom = '2px solid transparent';
                                    tabBtns[i].style.color = '#718096';
                                    tabBtns[i].style.fontWeight = 'normal';
                                }

                                // Show selected tab and mark button as active
                                document.getElementById('tab-' + tabName).style.display = 'block';
                                event.currentTarget.style.borderBottom = '2px solid #667eea';
                                event.currentTarget.style.color = '#667eea';
                                event.currentTarget.style.fontWeight = '600';
                            }
                        <\/script>
                    </head>
                    <body>${detailsHtml}</body>
                    </html>
                `);

            } catch (error) {
                showMessage('Error loading details: ' + error.message, 'error');
            }
        }

        // Download Axiom JSON
        async function downloadAxiom(tokenId) {
            try {
                const response = await fetch(`/api/tokens/${tokenId}`);
                const data = await response.json();

                if (!data || data.error) {
                    showMessage(data.error || 'Failed to load token data', 'error');
                    return;
                }

                // Get Axiom JSON
                const axiomJson = data.axiom_json;

                if (!axiomJson || axiomJson.length === 0) {
                    showMessage('No Axiom export data available', 'error');
                    return;
                }

                // Download as file
                const dataStr = JSON.stringify(axiomJson, null, 2);
                const blob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${data.acronym}_axiom_export.json`;
                a.click();
                URL.revokeObjectURL(url);

                showMessage('Axiom JSON downloaded successfully!', 'success');
            } catch (error) {
                showMessage('Error downloading Axiom JSON: ' + error.message, 'error');
            }
        }

        // Delete token
        async function deleteToken(tokenId, tokenName) {
            // Confirm deletion
            const confirmMsg = `Are you sure you want to delete "${tokenName}"?\n\n` +
                              `This will permanently remove:\n` +
                              `‚Ä¢ The token analysis record\n` +
                              `‚Ä¢ All associated wallet data\n` +
                              `‚Ä¢ The Axiom export JSON\n\n` +
                              `This action cannot be undone.`;

            if (!confirm(confirmMsg)) {
                return;
            }

            try {
                const response = await fetch(`/api/tokens/${tokenId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (!response.ok || data.error) {
                    showMessage(data.error || 'Failed to delete token', 'error');
                    return;
                }

                showMessage(`Successfully deleted "${tokenName}"`, 'success');

                // Reload tokens list
                await loadTokens();
            } catch (error) {
                showMessage('Error deleting token: ' + error.message, 'error');
            }
        }

        // Copy address to clipboard
        function copyAddress(address) {
            navigator.clipboard.writeText(address).then(() => {
                showMessage('Address copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showMessage('Failed to copy address', 'error');
            });
        }

        // Search
        document.getElementById('search').addEventListener('input', (e) => {
            renderTable(e.target.value);
        });

        // Show message
        function showMessage(text, type) {
            const el = document.getElementById('message');
            el.textContent = text;
            el.className = `message ${type}`;
            el.style.display = 'block';
            setTimeout(() => {
                el.style.display = 'none';
            }, 5000);
        }

        // Initialize
        loadTokens();
        setInterval(loadTokens, 30000); // Refresh every 30 seconds
    </script>
</body>
</html>